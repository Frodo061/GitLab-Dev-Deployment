- name: Database's provisioning and deployment
  hosts: localhost
  connection: local
  gather_facts: no
  roles:
    - role: gcp
      vars:
        gcp_zone: us-west1-b
        gcp_region: us-west1
        gcp_project: copper-gear-221110
        gcp_cred_kind: serviceaccount
        gcp_cred_file: ../.gcloud/gcloud.json
        gcp_machine_type: n1-standard-1
        source_image: projects/ubuntu-os-cloud/global/images/ubuntu-1604-xenial-v20181030
        disk_size: 12

        disks:
          # - consul-disk-01
          # - consul-disk-02
          # - consul-disk-03
          - database-disk-04
          # - database-disk-05
          # - database-disk-06
          # - pgbouncer-disk-07

        addresses:
          # - addr-1
          # - addr-2
          # - addr-3
          - addr-4
          # - addr-5
          # - addr-6
          # - addr-7

        instances:
          # - { index: 1, tag: [consul, omnibus], name: consul-1 }
          # - { index: 2, tag: [consul, omnibus], name: consul-2 }
          # - { index: 3, tag: [consul, omnibus], name: consul-3 }
          - { index: 1, tag: [database-master, omnibus], name: database-master }
          #- { index: 5, tag: [database-slave, omnibus], name: database-1 }
          #- { index: 6, tag: [database-slave, omnibus], name: datab#ase-2 }
          #- { index: 7, tag: [pgbouncer, omnibus], name: pgbouncer }

        # VPC main network
        network_name: gitlab-network
        firewall_private_name: gitlab-private-firewall
        firewall_public_name: gitlab-public-firewall
        subnetwork_private_ports: [80, 2049, 5432, 6379, 6432, 8301, 26379]
        subnetwork_public_ports: [22, 80, 9000]
        

#- name: Debug (get all ip addrs)
#  hosts: all
#  gather_facts: yes
#  tasks:
#    - debug:
#        msg: "{{ ansible_hostname }}"

#- name: Installing Omnibus
#  hosts:
#    - omnibus
#  become: yes
#  gather_facts: yes
#  roles:
#    - role: omnibus

#- name: Installing Consul
#  hosts:
#    - consul
#  become: yes
#  gather_facts: yes
#  roles:
#    - role: consul
#      vars:
#        - consul_hosts: "{{ groups['consul'] }}"

#- name: Intalling master postgres node
#  hosts:
#    - database-master
#  become: yes
#  gather_facts: yes
#  roles:
#    - role: postgres_master
#      vars:
#        listen_address: 0.0.0.0
#        listen_port: 5432
#        # FOR NON-HA
#        postgres_user: gitlab
#        postgres_user_hash_password: b7a289c0600988fe8e709dd2887e4d37
#        trust_auth_cidr_addresses: 10.240.0.0/16
        # FOR HA
        #trust_auth_cidr_addresses: 10.240.0.0/16
        #pgbouncer_user_password: be5544d3807b54dd0637f2439ecb03b9
        #sql_user_password: b7a289c0600988fe8e709dd2887e4d37
        #consul_hosts: "{{ groups['consul'] }}"

#- name: Intalling secondary postgres nodes
#  hosts:
#    - database-slave
#  become: yes
#  gather_facts: yes
#  roles:
#    - role: postgres_slave
#      vars:
#        listen_address: 0.0.0.0
#        trust_auth_cidr_addresses: 10.240.0.0/16
#        pgbouncer_user_password: be5544d3807b54dd0637f2439ecb03b9
#        sql_user_password: b7a289c0600988fe8e709dd2887e4d37
#        consul_hosts: "{{ groups['consul'] }}"
#
#- name: Intalling pgbouncer
#  hosts:
#    - pgbouncer
#  become: yes
#  gather_facts: yes
#  roles:
#    - role: pgbouncer
#      vars:
#        pgbouncer_user_password: be5544d3807b54dd0637f2439ecb03b9
#        consul_user_password: bc175b38365ec8781fa93720255dee85
#        consul_hosts: "{{ groups['consul'] }}"
#        listen_addr: "{{ ansible_default_ipv4.address }}"
#        listen_port: 6432
